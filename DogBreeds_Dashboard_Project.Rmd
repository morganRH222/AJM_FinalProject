---
title: "Dog Breed Popularity and Traits"
author: "Jeffrey Gonzales, Morgan Hertel, Amy Gill"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}

```

# Loading Required Packages

```{r}

library(tidyverse)
library(flexdashboard)
library(plotly)
library(DT)
library(stringr)
library(dplyr)
library(shiny)

```


# Reading Dataset Directly from GitHUb

```#{r}

breed_traits <- readr::read_csv(
  "https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-02-01/breed_traits.csv"
)

trait_description <- readr::read_csv(
  "https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-02-01/trait_description.csv"
)

breed_rank <- readr::read_csv(
  "https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-02-01/breed_rank.csv"
)

```

# Reading Downloaded Dataset

```{r}

breed_traits <- readr::read_csv("data/breed_traits.csv", show_col_types = FALSE)
trait_description <- readr::read_csv("data/trait_description.csv")
breed_rank <- readr::read_csv("data/breed_rank.csv", show_col_types = FALSE)

spec(breed_traits)
spec(trait_description)
spec(breed_rank)
```

# Cleaning Data

```{r}

breed_traits_clean <- breed_traits %>%
  mutate(
    Breed_no_paren = Breed %>%
      str_replace_all("[()]", "") %>%   # remove parenthesis characters
      str_squish()                      # remove extra spaces
  )

breed_rank_clean <- breed_rank %>%
  mutate(
    Breed_no_paren = Breed %>%
      str_replace_all("[()]", "") %>%
      str_squish()
  )

head(breed_traits_clean)
head(breed_rank_clean)
```

# Wrangling the Data for Analyses

## Long format for Ranking

```{r}

breed_rank_long <- breed_rank_clean %>%
  pivot_longer(
    cols = matches("^\\d{4} Rank$"), # columns like "2013 Rank", "2014 Rank", ...
    names_to = "year",
    values_to = "rank"
  ) %>%
  mutate(
    year = readr::parse_number(year)  # from "2013 Rank" -> 2013
  )

```


## Getting Most Recent Year Rank as "Current" Popularity

```{r}

breed_rank_latest <- breed_rank_clean %>%
  transmute(
    Breed_no_paren,
    latest_rank = `2020 Rank`
  ) %>%
  filter(!is.na(latest_rank)) %>%   
  arrange(latest_rank)

breed_rank_latest

```

## Joining Traits and latest rank into one dataframe

```{r}

dog_data <- breed_traits_clean %>%
  left_join(breed_rank_latest, by = "Breed_no_paren") %>%
  arrange(latest_rank)

min(dog_data$latest_rank, na.rm = TRUE)
dog_data %>% select(Breed, latest_rank) %>% head(10)

dog_data

```

## Creating a Vector of Breeds for Dropdown Menu

```{r}

breed_choices <- sort(unique(breed_rank_long$Breed))

breed_choices

```


## Creating a Vector of Trait Variables 
We want to allow the user to choose for the x-axis

```{r}

trait_vars <- breed_traits_clean %>%
  select(where(is.numeric)) %>%
  names()

trait_vars

```

## Creating a named vector for Select Input Choices

```{r}

trait_choices <- setNames(trait_vars, trait_vars)

trait_choices

```


# Graphing Plots for Dashboard Panes

## Popularity over time (for a selected breed)

```{r}

# function that returns a ggplot for one breed
plot_rank_over_time <- function(breed_name) {
  breed_rank_long %>%
    filter(Breed == breed_name) %>%
    ggplot(aes(x = year, y = rank)) +
    geom_line() +
    geom_point() +
    scale_y_reverse() +  # rank 1 at top
    labs(
      title = paste("AKC Rank over Time for", breed_name),
      x = "Year",
      y = "Rank (lower = more popular)"
    )
}

plot_rank_over_time
```

## Popularity vs One Trait (e.g. Trainability)

```{r}

gg_pop_vs_trait <- dog_data %>%
  ggplot(aes(x = `Trainability Level`, y = latest_rank)) +
  geom_point(alpha = 0.7) +
  scale_y_reverse() +
  labs(
    title = "Popularity vs Trainability (2020)",
    x = "Trainability Level",
    y = "2020 Rank (lower = more popular)"
  )

gg_pop_vs_trait
```

### Interactive Plots with plotly

```{r}

gg_pop_vs_trait_interactive <- plotly::ggplotly(gg_pop_vs_trait)

gg_pop_vs_trait_interactive
```


## Interactive Table with DT

```{r}

dog_table <- dog_data %>%
  select(Breed_no_paren, latest_rank, where(is.numeric))

datatable(
  dog_table,
  options = list(pageLength = 20),
  filter = "top"
)

dog_table

```

# Building the Flexdashboard


Column {data-width=650}
-----------------------------------------------------------------------

### Popularity over Time (AKC Rank)

```{r}

renderPlot({
req(input$breed_choice)

breed_rank_long %>%
filter(Breed == input$breed_choice) %>%
ggplot(aes(x = year, y = rank)) +
geom_line(color = "grey40") +
geom_point(size = 2) +
scale_y_reverse() +  # lower rank (1) at top
labs(
title = paste("AKC Rank over Time for", input$breed_choice),
x = "Year",
y = "AKC Rank (1 = most popular)"
) +
theme_minimal(base_size = 13)
})

```


Column {data-width=650}
-----------------------------------------------------------------------
### Popularity vs selected trait (interactive)

```{r}

renderPlotly({
req(input$trait_choice)

# Build a ggplot using the selected trait for the x-axis

p <- dog_data %>%
filter(!is.na(latest_rank)) %>%
ggplot(aes_string(
x = input$trait_choice,
y = "latest_rank",
text = "Breed"
)) +
geom_point(alpha = 0.7) +
scale_y_reverse() +
labs(
title = paste("Latest Popularity Rank vs", input$trait_choice),
x = input$trait_choice,
y = "Latest AKC Rank (lower = more popular)"
) +
theme_minimal(base_size = 13)

ggplotly(p, tooltip = c("text", "x", "y"))
})


```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
